---
title: "Florida Keys Reef Fish Biodiversity"
author: "Megan Hepner"
date: '2017-04-28'
categories: []
tags: []
---


Chunks based on original analysis by Megan Hepner from [github.com/mhepner90/RVC](https://github.com/mhepner90/RVC/blob/master/RVC_diversity_analysis.Rmd).

### Inputs
1. species-trait matrix
1. psu abundance dataframe
1. psu biomass dataframe

### Outputs
1.  Functional dendogram (Fig: The final ultrametric functional dendrogram for 348 reef fish in the Florida Keys obtained using hierarchial agglometric clustering.)
+ Trait-matrix visualization

1.  By *strata* for each sampling year (using PSU data)  
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot

1. By *strata grouped and subregion* for each sampling year (using PSU data)
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot

1. By *NTMR* for each sampling year (using PSU data)
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot

1. Figure of the FKNMS coral reef tract with strata, subregions, and NTMR

1. Statistics
- Interpolate diversity for each year and strata using kriging
+ Figure. Spatial distribution of each matrices over time.
- Extract and interpolate the residuals of each index fitted against each other using GAM
+ temporal variable: YEAR
+ spatial variable: Latitude, longitude
+ environmental variable: STRAT, habitat_cd, depth, bottom temperature
+ management variable: NTMR
- Calculate partial deviances

### Reef Visual Census Background

Reef fish community data used in this study were collected as part of the multi-agency Reef Visual Census (RVC) [Brandt et al., 2009](https://www.coris.noaa.gov/activities/fish_monitoring_protocol/). Fish communities were visually surveyed underwater annually in the mainland FKNMS (Lower Keys, Middle Keys and Upper Keys) from 1999 to 2012, and biennially from 2012 to 2016. The Dry Tortugas region was surveyed from 1999 to 2000 and biennially from 2004 to 2016.     

The RVC uses a stationary point count method within a randomly selected 7.5 m radius circular plot with a 200m map grid from 1999 to 2012 and 100m map grid from 2014 to 2016 to optimize the observation of conspicuous and diurnally active reef fish, specifically economically and ecologically important reef fish species [Bohnsack and Bannerot, 1986](https://docs.lib.noaa.gov/noaa_documents/NMFS/TR_NMFS/TR_NMFS_41.pdf).

### Objective

To analyze and compare changes in species richness, Simpson diversity, Shannon diversity and functional diversity in the Florida Keys National Marine Sanctuary (FKNMS) to reveal changes in temporal and spatial variability from 1999 â€“ 2016. The indices were assessed throughout the Florida Keys, between the upper and lower keys, between habitat types, and for different levels of management (Ecological Reserves (ER), Sanctuary Preservations Areas (SPA), and Special Use/Research Only Areas (SU/RO)).

## Diversity indicse as effective number of species

All indices were computed as effective number of species. Effective number of species is the number of equally abundance species needed to produce the observed value of a diversity index (Jost, 2006; Jost et al., 2010; MacArthur, 1965). Jost, 2006 refers to these as true measures of diversity, where prior to the conversion the diversity indices are simply measures of entropy.

- Species Richness is the number of species in a habitat sampled  

$Richness = \sum_{i=1}^S p_i^0$  

- Simpson diversity measures the probability that two individuals randomly selected from a sample will belong to different species.   

$Simpson = 1 - \sum_{i=1}^S p_i^2$  

- Shannon diveristy is a measure of entropy, it is the uncertainty in the species identity of a sample  

$Shannon = - \sum_{i=1}^S p_i \log_b p_i$  

- Functional diversity (Rao's Q) is a measure of pairwise functional differences between species weighted by their relative abundances   

$Rao Q = \sum_{i=1}^S-1 \sum_{j=i+1}^S d_i p_i p_j$

```{r setup, include=FALSE}
library(tidyverse)  # magrittr for >%>, tibble for as.tibble
library(FD)  # gowdis
library(ape) #read.tree, as.phylo
library(clue) #cl_consensus, cl_ultrametric, cl_dissimilarity,cl_ultrametric
library(cowplot) #get_legend
library(d3treeR) #d3treeR interactive traitmap
library(devtools) #install_github
library(fpc) #pamk
library(ggplot2) #ggplot
library(grid)
library(gridExtra) #grid.arrange
library(htmlwidgets) #save interactive treemap and pie chart
library(lattice)
library(mgcv) #gam
library(parallel) #clusterEvalQ,clusterExport,detectCores,makeCluster,parLapply
library(plotrix) #std.error
library(purrr) #map
library(readr) #saveRDS, read_rds, readRDS
library(reshape2) #melt
library(rvc) #getPSUAbundance, getStrataAbundance, getDomainAbundance
library(tidyverse) #select, filter, mutate, group_by, summarize
library(treemap) #treemap
library(vegan) #spec, diversity
library(webshot) #screenshot of interactive treemap and pie chart

map = purrr::map # override maps::map
select = dplyr::select #override MASS::select
group_by =  dplyr::group_by #override plotly::group_by
summarise = dplyr::summarise #override plotly::summarise
```

## Functional distance trait based matrix
from Lefcheck et al., 2014 ChessMap.Rmd

TODO: fix & include func_dist_trait_matrix chunk
```{r child = 'func_dist_trait_matrix.Rmd', eval=FALSE, include=FALSE}
```

Top 23 species = 80% of species

* Bicolor Damselfish
* Bluehead
* Masked Goby
* Tomtate
* White Grunt
* Striped Parrotfish
* Reef Silverside
* Slippery Dick
* Yellowtail Snapper
* Redband Parrotfish
* French Grunt
* Bluestriped Grunt
* Yellowhead Wrasse
* Ocean Surgeon
* Hardhead Silverside
* Clown Wrasse
* Sergeant Major
* Bar Jack
* Blue Tang
* Brown Chromis
* Creole Wrasse
* Gray Snapper
* Doctorfish

TODO: fix & include trait_matrix chunk
```{r child = 'trait_matrix.Rmd', eval=FALSE, echo=FALSE}
```

## Trait matrix visualization
```{r child = 'trait_matrix_viz.Rmd'}
```
