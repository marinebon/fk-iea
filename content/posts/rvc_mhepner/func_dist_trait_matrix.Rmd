
Gowdis computes the Gower (1971) similarity coefficient exactly as described by Podani (1999), then converts it to a dissimilarity coefficient by using D = 1 - S



```{r Functional distance matrix, eval=FALSE, echo=TRUE}
func.dist = read_rds("https://github.com/mhepner90/RVC/blob/master/functional_diversity/func_dist_rds?raw=true")

func_dist_common = read_rds("https://github.com/mhepner90/RVC/blob/master/functional_diversity/func_dist_common_name_rds?raw=true")
func_dist_phy_common = as.phylo(as.hclust(func_dist_common))

#Plot the best tree - average
#removes 298/348 species
#pdf("functional_diversity/functional_dendrogram_2.pdf", width = 7, height = 10)
sup = drop.tip(func_dist_phy_common, sample(func_dist_phy_common$tip.label)[1:298])
par(mfrow=c(1,1))
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 1.5)
dev.off()

#removes 150/348 species 2 pages
#pdf("functional_diversity/functional_dendrogram_2.pdf", width = 7, height = 20)
sup = drop.tip(func_dist_phy_common, sample(func_dist_phy_common$tip.label)[1:150])
par(mfrow=c(1,1))
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 1.5)
dev.off()

#with scale
#pdf("functional_diversity/functional_dendrogram.pdf", width = 8.5, height = 70)
#par(mar=c(0,0,0,0)) #number of lines of margins for bottom, left, top, right
#par(pin=c(4.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

tiff("functional_diversity/functional_dendrogram.tiff", width = 8.5, height = 70)
#par(mar=c(0,0,0,0)) #number of lines of margins for bottom, left, top, right
#par(pin=c(4.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

#with scale
tiff("fd.tiff", width = 8.5, height = 70, units = "in", res = 300)
#par(pin=c(3.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

#Plot the best tree - average
#pdf("functional_diversity/functional_dendrogram.pdf", width = 7, height = 80)
par(mfrow=c(1,1))         #nc-by-nr array
par(mar=c(2,1,0,2))  #number of lines of margins for bottom, left, top, right
#par(pin=c(5,70))    #plot dimensions (width, height)
plot(func.dist, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 1.5, cex.lab = 1)
dev.off()

#Plot the best tree - average
#removes 260/348 species
#pdf("functional_dendrogram.pdf", width = 7, height = 10)
sup = drop.tip(func.dist, sample(func.dist$tip.label)[1:260])
par(mfrow=c(1,1))
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 2)
dev.off()

#pdf("functional_dendrogram.pdf", width = 7, height = 70)
par(mfrow=c(1,1))
plot(func.dist, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 2) #cex.lab = 0.5
dev.off()

#Phylogenetic tree with 348 tips and 347 internal nodes.
func.dist.phy = as.phylo(as.hclust(func.dist))

#Write newick tree
write.tree(func.dist.phy, "functional_diversity/functional_dendrogram.nwk")
#write.nexus(func.dist.phy, "functional_diversity/functional_dendrogram.nex")

tree <- read.tree("functional_diversity/functional_dendrogram.nwk")
# List of 4
#  $ edge       : int [1:694, 1:2]
#  $ Nnode      : int 347
#  $ tip.label  : chr [1:348]
#  $ edge.length: num
# - attr(*, "class")= chr "phylo"
# - attr(*, "order")= chr "cladewise"

# Phylogenetic tree with 348 tips and 347 internal nodes.
# Tip labels:
# 	KYP_SECT, ALE_CILI, ELO_SAUR, HAR_JAGU, CEN_UNDE, TYL_CROC, ...
# Rooted; includes branch lengths.

plot(tree, label.offset=0.2, edge.width = 2, type = "cladogram")  
nodelabels() #add node numbers
tiplabels() #add tip numbers

ggtree(tree, branch.length = T) +
  ggtitle("Functional Dendogram") +
  geom_tiplab()+
  geom_text(aes(x = branch, label=branch.length), vjust = -.5) +
  theme_tree2()

ggtree(tree, layout= "circular") +
  ggtitle("Functional Dendogram") +
  geom_tiplab(size = 1, aes(angle=angle))+
  theme_tree2()

# transformed to a tidy data.frame by fortify method
tree_data <- fortify(tree) #node; parent; branch.length; x; y; label; isTip; branch; angle
head(tree_data)

#Visualize species' differences in multivariate trait space
#Perform k-means clustering with no a priori specification for k
traits.kclus= pamk(traits.dist, krange=2:10)

traits.kclus.common= pamk(traits.dist.common, krange=2:10)

#krange: integer vector. Numbers of clusters which are to be compared by the average silhouette width criterion.
#traits.kclus$nc = 10
#traits.kclus$crit 0.0000000 0.2374706 0.2362513 0.2355555 0.2681756 0.2581352 0.2759547 0.2852216 0.3006077 0.3062123

# #Perform nonmetric multidimensional scaling (NMDS) on functional dendrogram
traits_nmds = metaMDS(traits.dist,k=traits.kclus$nc,trymax=20)

traits_nmds.common = metaMDS(traits.dist.common,k=traits.kclus.common$nc,trymax=300)
#k = Number of dimensions

#*** No convergence -- monoMDS stopping criteria:
#499: no. of iterations >= maxit
#1: stress ratio > sratmax

# Dimensions: 10
# Stress:     0.03545178
# Stress type 1, weak ties
# No convergent solutions - best solution after 500 tries
# Scaling: centring, PC rotation
# Species: scores missing


# #Plot in two dimensions - doesn't work
par(mar=c(4,4,1,1))
ordiplot(traits_nmds.common,type="n") #type="n"type="points"

#Assign colors to different groups
groups=levels(factor(traits.kclus.common$pamobject$clustering))
points.symbols=15:16
points.colors=c("firebrick3","cornflowerblue")
for(i in seq_along(groups)) {
  points(traits_nmds.common$points[traits.kclus.common$pamobject$clustering==groups[i],],
         pch=points.symbols[i],col=points.colors[i],cex=1.4) }
ordispider(traits_nmds.common,factor(traits.kclus.common$pamobject$clustering),label=F)
ordihull(traits_nmds.common,factor(traits.kclus.common$pamobject$clustering),lty="dotted")
orditorp(traits_nmds.common,dis="sites",pcex=0,air=0.5,col="grey10",cex=0.8)

```
